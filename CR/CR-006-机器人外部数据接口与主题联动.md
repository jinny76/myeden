# 需求变更申请单 - CR-006-机器人外部数据接口与主题联动

## 1. 变更基本信息
| 项目名称 | 变更编号 | 申请日期   | 申请人 | 变更类型 |
| -------- | -------- | ---------- | ------ | -------- |
| 我的伊甸园 | CR-006   | 2025-07-03 | JINNI | 功能增强 |

## 2. 变更描述

### 2.1 变更背景
当前机器人生成内容时，主题虽丰富但缺乏实时性和外部信息支撑，导致内容同质化、缺乏新鲜感。为提升机器人的拟人化和内容多样性，需引入外部数据（如新闻、热搜、天气、音乐、影视等），并与分享主题智能联动，实现每日内容与真实世界同步。

### 2.2 变更目标
1. 实现外部数据（新闻、热搜、天气、音乐、影视等）自动采集与缓存。
2. 支持robots-config.yaml中主题与外部数据类型的灵活映射。
3. 机器人生成内容时，自动根据所选主题插入对应数据背景，提升内容时效性和个性化。
4. 保证数据每日自动更新，系统稳定高可用。

### 2.3 变更内容
- 新增外部数据采集与缓存模块，定时拉取并存储各类数据。
- robots-config.yaml主题支持data_type字段，指明所需外部数据类型。
- PromptServiceImpl在选择主题后，自动检索并插入对应数据片段到提示词上下文。
- 支持每日自动更新，异常时自动降级为默认内容。

## 3. 影响分析

### 3.1 功能影响
- 影响模块：机器人内容生成、配置管理、外部数据采集
- 影响功能：机器人动态/评论/回复生成逻辑，主题配置结构
- 用户影响：机器人内容更丰富、贴近现实，提升用户体验

### 3.2 技术影响
- 前端影响：无直接影响，内容展示更丰富
- 后端影响：需新增外部数据采集服务、缓存管理、PromptServiceImpl逻辑调整
- 数据库影响：如需持久化缓存，需新增外部数据表（可选）
- 第三方集成：需对接新闻、热搜、天气、音乐、影视等外部API

## 4. 变更历史
| 版本 | 修订日期   | 修订人 | 修订内容   |
| ---- | ---------- | ------ | ---------- |
| V1.0 | 2025-07-03 | JINNI | 初版创建   |

## 5. 变更设计

### 5.1 后端相关设计

2. **实体类相关设计**  
   - 新增：NewsItem、WeatherInfo、MusicItem、MovieItem等数据实体

3. **数据库操作类相关设计**  
   - 可选：只需要保存当天数据, 每天刷新

4. **服务类相关设计**  
   - 新增：ExternalDataService接口及实现，负责采集各类外部数据
   - 新增：ExternalDataCache，负责数据缓存与按主题检索
   - 新增：ExternalDataScheduler，定时任务每日采集数据

5. **接口类相关设计**  
   - PromptServiceImpl调整：选择主题后自动插入对应数据背景

6. **缓存持久化与线程安全**  
   - 新增ExternalDataCache，支持本地JSON持久化，服务启动时自动加载，刷新后自动保存。
   - 新增ExternalDataCacheService，封装缓存的线程安全读写与统一管理，保证多线程环境下数据一致性。

7. **定时任务自动刷新**  
   - 新增ExternalDataScheduler，采用Spring定时任务，每天定时采集外部数据并刷新缓存，采集后自动持久化。

### 5.2 前端相关设计

1. 路由相关设计  
   - 无需调整

2. 工具类设计  
   - 无需调整

3. 组件类设计  
   - 无需调整

4. 视图设计  
   - 无需调整，内容展示更丰富

## 6. 任务安排

### 任务分解
- [ ] 步骤1：设计并实现ExternalDataService接口及各类数据采集实现
- [ ] 步骤2：实现ExternalDataCache缓存结构，支持按主题类型检索
- [ ] 步骤3：实现ExternalDataScheduler定时任务，自动每日采集数据
- [ ] 步骤4：调整robots-config.yaml，主题增加data_type字段
- [ ] 步骤5：调整PromptServiceImpl，生成内容时根据主题自动插入数据背景
- [ ] 步骤6：联调测试，保证异常时自动降级为默认内容
- [ ] 步骤7：完善文档与代码注释

---
