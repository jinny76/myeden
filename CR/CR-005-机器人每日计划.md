# 需求变更申请单 - CR-005-机器人每日计划

## 1. 变更基本信息
| 项目名称 | 变更编号 | 申请日期   | 申请人 | 变更类型 |
| -------- | -------- | ---------- | ------ | -------- |
| 我的伊甸园 | CR-005   | 2025-07-02 | JINNI | 功能增强 |

## 2. 变更描述
### 2.1 变更背景
为提升机器人个性化和拟人化体验，需为每个机器人生成并管理"每日计划"，让机器人拥有丰富的日常行为轨迹，便于后续AI驱动的动态生成和互动。

### 2.2 变更目标
1. 支持为每个机器人维护每日计划（可包含多条时间段安排，每段可有多个事件）。
2. 支持每日计划的增删改查（CRUD）服务。
3. 支持AI自动生成机器人每日计划（通过提示词）。
4. 每天凌晨自动为所有机器人生成当天的计划。

### 2.3 变更内容
- 新增RobotDailyPlan、PlanSlot、PlanEvent等实体类。
- 实现每日计划的CRUD接口与服务。
- 设计AI提示词，自动生成机器人一天的详细计划。
- 增加定时任务，凌晨批量生成所有机器人的计划。
- 需要注意周末和节假日
- 在分享和回复时, 获取当前状态, 作为背景信息。

## 3. 影响分析
### 3.1 功能影响
- 影响模块：机器人管理、AI内容生成、定时任务
- 影响功能：机器人日常行为、用户互动内容丰富度
- 用户影响：提升机器人拟人化体验，用户可查看机器人每日计划(暂不支持编辑)

### 3.2 技术影响
- 前端影响：[UI/UX变更] 新增机器人每日计划展示组件
- 后端影响：[API/业务逻辑变更] 新增实体、Repository、Service、Controller、定时任务
- 数据库影响：[数据结构变更] 新增每日计划相关表/集合
- 第三方集成：[外部系统影响] AI大模型接口调用

## 4. 变更历史
| 版本 | 修订日期   | 修订人 | 修订内容     |
| ---- | ---------- | ------ | ------------ |
| V1.0 | 2025-07-02 | JINNI | 初版创建     |

## 5. 变更设计

### 5.1 后端相关设计

#### 1. Entity设计
```java
// 机器人每日计划主对象
public class RobotDailyPlan {
    private String id;
    private String robotId;         // 关联机器人
    private String diary;           // 日记
    private LocalDate planDate;     // 计划日期
    private List<PlanSlot> slots;   // 一天内的时间段安排
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private Boolean isDeleted;
}

// 时间段安排
public class PlanSlot {
    private String start;           // 开始时间（如06:00）
    private String end;             // 结束时间（如07:30）
    private List<PlanEvent> events; // 该时间段内的事件
}

// 具体事件
public class PlanEvent {
    private String content;         // 事件内容（如"早起洗漱"，"面膜不见了"）
    private String mood;            // 心情 (如开心, 难过, 生气, 惊恐)
}
```

#### 2. Repository设计
- RobotDailyPlanRepository：支持按robotId、planDate查询。

#### 3. Service设计
- RobotDailyPlanService
  - getPlan(robotId, planDate)
  - getEventContext(robotId): 获取机器人当前时间的安排, 包括事件
  - generatePlanByAI(robotId, planDate)：调用AI生成计划, 多次调用更新计划
  - batchGenerateAllRobotsPlanByAI(planDate)：为所有机器人生成计划

#### 4. Controller设计
- RobotDailyPlanController
  - GET /api/robot/plan?robotId=&planDate= 查询计划
  - POST /api/robot/plan/ai 生成AI计划

#### 5. 定时任务
- 每天凌晨（如00:10）自动调用batchGenerateAllRobotsPlanByAI(planDate)，为所有机器人生成当天计划。

### 5.2 前端相关设计

#### 1. 路由相关设计
- 新增"机器人每日计划"页面，支持按日期、机器人筛选。

#### 2. 工具类设计
- 封装AI计划生成API调用
- 时间格式化工具

#### 2. 视图设计
- 世界新增机器人日记页
- 支持搜索查看

### 6 任务安排

## 任务分解
- [ ] 设计并实现RobotDailyPlan、PlanSlot、PlanEvent实体
- [ ] 实现RobotDailyPlan的Repository、Service、Controller
- [ ] 实现每日计划的CRUD接口
- [ ] 设计AI提示词，开发AI计划生成接口
- [ ] 实现定时任务，凌晨批量生成计划
- [ ] 前端开发每日计划管理与展示页面
- [ ] 前后端联调与测试
- [ ] 发分享和回复时, 获取机器人当前安排, 作为背景发送

---

### AI提示词设计, 参考机器人属性, 主要是当前日期, 职业, 性格等, 生成提示词来调用AI生成当天计划, 包括一篇日记和多条安排, 注意格式