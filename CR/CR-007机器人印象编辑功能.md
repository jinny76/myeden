# 需求变更申请单 - CR-007机器人印象编辑功能

## 1. 变更基本信息
| 项目名称 | 变更编号 | 申请日期   | 申请人 | 变更类型   |
| -------- | -------- | ---------- | ------ | ---------- |
| 我的伊甸园 | CR-007   | 2024-07-04 | JINNI | 功能增强   |

## 2. 变更描述

### 2.1 变更背景
当前机器人与用户建立连接后，机器人对用户的行为和反馈是静态的，缺乏个性化和互动性。为提升用户体验和机器人智能度，需支持用户主动编辑“机器人对我的印象”，让机器人在生成评论和回复时能体现出对用户的独特看法和情感色彩。

### 2.2 变更目标
1. 用户可在前端界面直接编辑机器人对自己的印象，内容为多行文本。
2. 机器人在生成动态评论、对用户评论的回复时，能参考并体现该印象内容，实现更个性化的交互。
3. 印象编辑入口集成在世界页面机器人卡片上，操作便捷，输入后立即生效。

### 2.3 变更内容
- 前端：在`World.vue`机器人卡片上新增“印象”按钮，点击弹出多行文本编辑层，支持保存。
- 后端：为机器人-用户连接关系增加印象字段，提供增删改查API，内容变更后实时生效。
- 机器人内容生成逻辑：在生成评论和回复时，自动注入印象内容作为Prompt上下文。

---

## 3. 影响分析

### 3.1 功能影响
- 影响模块：机器人-用户连接、评论生成、回复生成
- 影响功能：机器人评论、机器人回复、用户个性化体验
- 用户影响：用户可主动塑造机器人对自己的印象，提升互动乐趣和归属感

### 3.2 技术影响
- 前端影响：UI增加印象编辑入口、弹窗、多行文本输入，需与后端API联动
- 后端影响：连接关系表结构调整，API扩展，内容生成服务需支持印象注入
- 数据库影响：机器人-用户连接表新增impression字段
- 第三方集成：无影响

---

## 4. 变更历史
| 版本 | 修订日期   | 修订人   | 修订内容         |
| ---- | ---------- | -------- | ---------------- |
| V1.0 | 2025-07-04 | JINNI | 初版创建         |

---

## 5. 变更设计

### 5.1 后端相关设计

1. **数据库相关设计**
   - 机器人-用户连接表（如`user_robot_link`或MongoDB集合）新增字段：
     - `impression`：String，存储用户自定义的印象内容，支持多行文本，最大长度建议500字。

2. **实体类相关设计**
   - `UserRobotLink`实体类新增`impression`字段，getter/setter。
   - 若有DTO/VO同步调整。

3. **数据库操作类相关设计**   

4. **服务类相关设计**
   - 在内容生成服务（如`PromptServiceImpl`）中，获取印象内容并注入到评论/回复Prompt上下文。

5. **接口类相关设计**
   - 检查是否有更新机器人-用户连接的服务, 确保印象可以被正确更新到数据库

### 5.2 前端相关设计

1. **路由相关设计**
   - 无需新增路由，功能集成在`World.vue`页面。

2. **工具类设计**

3. **组件类设计**
   - 在机器人卡片上新增“印象”按钮
   - 弹出层（Dialog/Drawer）：包含多行文本框，支持编辑和保存
   - 保存后立即调用API更新机器人连接对象，内容实时生效

4. **视图设计**
   - 机器人卡片操作区增加“印象”按钮
   - 弹窗标题如“编辑机器人对我的印象”
   - 多行文本框，底部有“保存”按钮，保存后自动关闭弹窗并提示“保存成功”

---

## 6. 任务安排

### 任务分解
- [ ] 步骤1：数据库表/集合结构调整，增加impression字段
- [ ] 步骤2：后端实体、Repository层支持印象的更新
- [ ] 步骤3：前端API方法实现与后端联调
- [ ] 步骤4：World.vue机器人卡片增加“印象”按钮及弹窗UI
- [ ] 步骤5：内容生成服务注入印象内容到Prompt上下文
- [ ] 步骤6：测试全流程，确保印象内容实时生效 