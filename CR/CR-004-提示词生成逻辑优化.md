# 需求变更申请单 - CR-004-提示词生成逻辑优化

## 1. 变更基本信息
| 项目名称 | 变更编号 | 申请日期 | 申请人 | 变更类型 |
| -------- | -------- | -------- | ------ | -------- |
| 我的伊甸园 | CR-004   | 2024-12-19 | 太白雪霁 | 功能优化 |

## 2. 变更描述
### 2.1 变更背景
当前提示词生成逻辑存在以下问题：
1. 机器人背景信息构建过于固定，缺乏随机性和个性化
2. 所有机器人的提示词结构过于相似，缺乏差异化
3. 无法根据机器人配置灵活选择性地生成背景信息
4. 缺乏对机器人属性的智能选择和组合机制

### 2.2 变更目标
1. 实现智能机器人属性选择器，支持多级属性获取
2. 重构提示词生成逻辑，增加随机性和个性化
3. 提供灵活的属性选择机制，支持空值几率和单元数量控制
4. 优化机器人背景信息的构建方式

### 2.3 变更内容
1. 实现智能机器人属性选择器 `getRobotValue()` 方法
2. 重构背景信息构建方法 `buildSmartBackground()`
3. 重构个人档案构建方法 `buildSmartPersonalInfo()`
4. 优化所有提示词构建方法（动态、评论、回复、内心活动）
5. 添加测试接口验证功能

## 3. 影响分析
### 3.1 功能影响
- 影响模块：PromptService、RobotController
- 影响功能：AI内容生成、机器人个性化、提示词构建
- 用户影响：提升AI生成内容的个性化和随机性

### 3.2 技术影响
- 前端影响：无
- 后端影响：重构提示词服务，新增智能选择器
- 数据库影响：无
- 第三方集成：无

## 4. 变更历史
| 版本 | 修订日期 | 修订人 | 修订内容 |
| ---- | -------- | ------ | -------- |
| V1.0 | 2024-12-19 | 太白雪霁 | 初版创建 |

## 5. 变更设计

### 5.1 后端相关设计

#### 5.1.1 核心方法设计
1. **智能属性选择器 `getRobotValue()`**
   ```java
   /**
    * 智能机器人属性选择器
    * @param robot 机器人实体
    * @param robotInfo 机器人配置信息
    * @param attributePath 属性路径，支持多级，如 "speakingStyle.speechPatterns"
    * @param maxUnits 最大返回单元数量
    * @param nullProbability 空值几率 (0.0-1.0)
    * @return 选中的属性值数组
    */
   private List<String> getRobotValue(Robot robot,
                                    String attributePath, int maxUnits, double nullProbability)
   ```

2. **智能背景构建 `buildSmartBackground()`**
   ```java
   /**
    * 构建智能背景信息
    * 使用智能选择器构建机器人的背景信息
    */
   private String buildSmartBackground(Robot robot)
   ```

3. **智能个人档案构建 `buildSmartPersonalInfo()`**
   ```java
   /**
    * 构建智能个人档案
    * 使用智能选择器构建机器人的个人档案
    */
   private String buildSmartPersonalInfo(Robot robot)
   ```

#### 5.1.2 辅助方法设计
1. **属性值获取 `getPropertyValue()`**
   - 使用反射获取对象的属性值
   - 支持多级属性路径访问

2. **单元提取 `extractUnits()`**
   - 处理字符串、列表等不同类型的数据
   - 支持多行字符串和逗号分隔的字符串

3. **随机单元选择 `selectRandomUnits()`**
   - 根据空值几率和单元数量进行随机选择
   - 避免重复选择

### 5.2 功能特性

#### 5.2.1 智能属性选择
- **多级属性支持**：支持 `speakingStyle.speechPatterns` 这样的多级属性路径
- **空值几率控制**：可以设置属性为空的概率，增加随机性
- **单元数量控制**：可以限制返回的单元数量
- **类型自适应**：自动处理字符串、列表等不同类型的数据

#### 5.2.2 随机化机制
- **选择性显示**：不是所有属性都会显示，增加变化性
- **概率控制**：每个属性都有独立的显示概率
- **内容组合**：不同属性组合产生不同的背景信息

#### 5.2.3 个性化增强
- **差异化背景**：不同机器人生成不同的背景信息
- **动态组合**：每次生成都可能产生不同的组合
- **真实感提升**：更接近真实人物的信息展示方式

## 6. 任务安排

### 任务分解
- [x] 步骤1：设计智能属性选择器算法
- [x] 步骤2：实现核心方法 `getRobotValue()`
- [x] 步骤3：实现辅助方法 `getPropertyValue()`, `extractUnits()`, `selectRandomUnits()`
- [x] 步骤4：重构背景信息构建方法
- [x] 步骤5：重构个人档案构建方法
- [x] 步骤6：优化所有提示词构建方法
- [x] 步骤7：添加测试接口和验证方法
- [ ] 步骤8：集成测试和性能优化

### 优先级评估
- 业务优先级：高
- 技术复杂度：中
- 实施周期：已完成核心功能

### 里程碑安排
| 阶段 | 开始时间 | 结束时间 | 交付物 | 负责人 |
| ---- | -------- | -------- | ------ | ------ |
| 设计 | 2024-12-19 | 2024-12-19 | 智能选择器算法设计 | 太白雪霁 |
| 开发 | 2024-12-19 | 2024-12-19 | 核心功能实现 | 太白雪霁 |
| 测试 | 2024-12-19 | 2024-12-19 | 功能验证 | 太白雪霁 |
| 部署 | 2024-12-19 | 2024-12-19 | 代码提交 | 太白雪霁 |

## 7. 使用示例

### 7.1 基本用法
```java
// 获取机器人的说话习惯，最多2个，空值几率60%
List<String> speechPatterns = getRobotValue(robot,
    "speakingStyle.speechPatterns", 2, 0.6);

// 获取机器人的兴趣爱好，最多3个，空值几率30%
List<String> interests = getRobotValue(robot,
    "interests", 3, 0.3);

// 获取机器人的职业信息，最多1个，空值几率20%
List<String> occupation = getRobotValue(robot, 
    "occupation", 1, 0.2);
```


### 7.3 预期效果
- 每次生成的提示词都会有所不同
- 机器人的个性特征更加突出
- 背景信息更加丰富和真实
- 提升了AI生成内容的多样性 