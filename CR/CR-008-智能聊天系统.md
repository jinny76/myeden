# 需求变更申请单 - CR-008-智能聊天系统

## 1. 变更基本信息
| 项目名称     | 变更编号 | 申请日期   | 申请人 | 变更类型 |
| ------------ | -------- | ---------- | ------ | -------- |
| 我的伊甸园AI聊天 | CR-008   | 2025-07-05 |     JINNI    | 功能新增 |

## 2. 变更描述
### 2.1 变更背景
随着AI技术的发展，用户对智能陪伴和个性化互动的需求日益增长。为提升平台活跃度和用户粘性，计划引入“AI聊天系统”，让用户可以随时与AI进行自然语言对话，同时AI也能主动发起聊天，形成持续的互动体验。

### 2.2 变更目标
1. 用户可以随时主动与AI进行文字聊天，获得智能回复。
2. AI可以根据设定的规则或时机，主动向用户发起聊天。
3. 所有聊天信息（无论谁发起）都将完整保存，支持历史记录查询。

### 2.3 变更内容
- 新增“AI聊天”模块，支持用户与AI的双向对话。
- 聊天内容持久化存储，支持无限历史记录检索。
- 支持AI主动发起对话（如定时问候、情感关怀等）。
- 前端提供聊天窗口，体验类似主流IM。
- 后端提供聊天消息管理、AI对话生成、历史记录查询等接口。

## 3. 影响分析
### 3.1 功能影响
- 影响模块：新增“AI聊天”模块
- 影响功能：用户与AI的消息收发、历史记录管理
- 用户影响：提升互动体验，增加平台粘性

### 3.2 技术影响
- 前端影响：需新增新的私聊模块, 列出机器人、点击进入聊天窗口, 消息展示与输入、历史记录滚动加载等
- 后端影响：需新增聊天消息表、消息管理服务、AI对话生成服务、消息推送机制
- 数据库影响：需设计聊天消息表，支持高并发读写和历史检索

## 4. 变更历史
| 版本 | 修订日期   | 修订人 | 修订内容   |
| ---- | ---------- | ------ | ---------- |
| V1.0 | 2024-07-05 |   JINNI     | 初版创建   |

## 5. 变更设计

### 5.1 后端相关设计
1. 数据库相关设计
   - 新增聊天消息表（如chat_message），字段包括：消息ID、发送者、接收者、消息内容、时间戳、消息类型（用户/AI）、会话ID、conversationId等。
2. 实体类相关设计
   - ChatMessage实体类，封装消息属性。
3. 数据库操作类相关设计
   - ChatMessageRepository，支持消息的增删查。
4. 服务类相关设计
   - ChatService：处理消息收发、历史查询、AI消息生成。
   - 新增 getHistoryWithRobot(userId, robotId, limit, offset) 方法，支持根据机器人ID获取与该机器人所有历史消息，支持分页。
   - AIChatService：封装与AI对话生成相关的逻辑。
   - AI主动发起消息逻辑：
     - 通过定时任务（@Scheduled）、事件监听或AI策略触发AI消息生成。
     - 生成ChatMessage对象，senderType=ai，receiverId=目标用户，内容可自定义或由AI生成。
     - 消息保存至chat_message表，并通过WebSocket等方式推送到前端。
5. 接口类相关设计
   - 聊天消息发送接口（POST /api/chat/send）
   - 聊天历史查询接口（GET /api/chat/history）
   - 新增“根据robotId获取聊天消息”接口（GET /api/chat/history/robot?userId=xxx&robotId=yyy&limit=20&offset=0）
   - AI主动发起消息接口（内部定时/事件触发）

### 5.2 前端相关设计
1. 路由相关设计
   - 新增“AI聊天”页面路由（如 /chat）
2. 工具类设计
   - 聊天消息格式化、时间戳处理等工具
3. 组件类设计
   - ChatList.vue：机器人列表页，展示所有可聊天的机器人，点击进入聊天窗口。
   - ChatWindow.vue：聊天主窗口，负责加载与指定机器人（robotId）的历史消息，支持分页滚动加载。
   - MessageList.vue：消息列表组件，展示消息气泡、时间戳、已读状态等。
   - MessageInput.vue：消息输入框组件，支持发送消息，发送后自动刷新消息列表。
4. 视图设计
   - 聊天主界面，支持消息气泡、历史滚动、AI头像等，体验类似主流IM。
5. 交互说明
   - 聊天窗口加载时自动获取历史消息，支持向上滚动分页加载。
   - 发送消息后自动追加到消息列表。
   - 支持AI主动消息推送（WebSocket或轮询，后续可扩展）。

## 6 任务安排

## 任务分解
- [x] 设计聊天消息表结构
- [x] 实现ChatMessage实体类与Repository
- [x] 开发ChatService接口及getHistoryWithRobot方法
- [ ] 实现聊天消息收发与历史接口
- [ ] 实现根据robotId获取聊天消息接口（Controller与Repository实现）
- [~] 前端实现聊天窗口及消息展示（进行中：已完成组件结构设计与接口联调方案）
- [~] 支持AI主动发起消息的后端逻辑（进行中：已完成定时/事件触发与推送机制设计）
- [ ] 前后端联调与测试 