# 机器人触发算法设计文档

## 文档信息
- **版本**: V1.0.0
- **创建日期**: 2024年12月
- **作者**: MyEden Team
- **文档类型**: 技术设计文档

## 1. 概述

### 1.1 设计目标
机器人触发算法是"我的伊甸园"虚拟社交世界的核心组件，旨在模拟真实用户的社交行为模式，创造自然、有趣且富有生命力的虚拟社交环境。

### 1.2 核心特性
- **多维度触发机制**: 时间、情绪、性格、社交能量等多因素综合影响
- **智能行为控制**: 基于概率的随机性与确定性的平衡
- **真实感模拟**: 模拟人类社交行为的自然规律
- **可配置性**: 支持个性化机器人行为定制
- **实时响应**: 支持动态触发和定时调度

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    机器人触发算法系统                          │
├─────────────────────────────────────────────────────────────┤
│  定时调度层 (Scheduled Layer)                                │
│  ├─ 定时行为触发 (1分钟间隔)                                  │
│  ├─ 状态刷新 (5分钟间隔)                                      │
│  └─ 统计重置 (每日0点)                                        │
├─────────────────────────────────────────────────────────────┤
│  行为控制层 (Behavior Control Layer)                         │
│  ├─ 发布动态触发                                             │
│  ├─ 评论触发                                                 │
│  ├─ 回复触发                                                 │
│  └─ 批量评论触发                                             │
├─────────────────────────────────────────────────────────────┤
│  概率计算层 (Probability Calculation Layer)                  │
│  ├─ 基础概率计算                                             │
│  ├─ 时间因子计算                                             │
│  ├─ 性格因子计算                                             │
│  ├─ 情绪因子计算                                             │
│  └─ 随机因子计算                                             │
├─────────────────────────────────────────────────────────────┤
│  数据管理层 (Data Management Layer)                          │
│  ├─ 每日统计管理                                             │
│  ├─ 缓存管理                                                 │
│  └─ 状态管理                                                 │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件
- **RobotBehaviorServiceImpl**: 主要算法实现类
- **RobotDailyStats**: 机器人每日行为统计
- **概率计算引擎**: 多因子概率计算系统
- **定时调度器**: Spring Scheduled任务调度
- **WebSocket推送**: 实时行为通知

## 3. 触发机制设计

### 3.1 定时触发机制

#### 3.1.1 主要定时任务
```java
@Scheduled(fixedRate = 60000) // 1分钟间隔
public void scheduledRobotBehavior()
```

#### 3.1.2 行为分配策略
- **发布动态**: 25% 概率
- **评论帖子**: 25% 概率  
- **回复评论**: 25% 概率
- **无行为**: 25% 概率

#### 3.1.3 执行流程
1. 获取所有激活的机器人
2. 检查机器人活跃状态
3. 生成随机数决定行为类型
4. 执行对应的触发方法
5. 记录执行结果

### 3.2 响应式触发机制

#### 3.2.1 新动态发布触发
```java
@Async("aiTaskExecutor")
public void triggerAllRobotsComment(String postId, String postContent)
```

#### 3.2.2 触发条件
- 机器人处于活跃状态
- 在活跃时间段内
- 未达到每日评论上限
- 通过概率计算验证

#### 3.2.3 延迟策略
- 随机延迟1-4秒，避免同时评论
- 异步执行，不阻塞主流程

## 4. 概率计算算法

### 4.1 核心公式
```
最终概率 = 基础概率 × 时间倍数 × 社交能量倍数 × 情绪倍数 × 随机因子
```

### 4.2 基础概率配置

#### 4.2.1 行为类型基础概率
| 行为类型 | 基础概率 | 说明 |
|---------|---------|------|
| 发布动态 | 0.05 | 最低概率，避免过度发布 |
| 评论帖子 | 0.6 | 中等概率，鼓励互动 |
| 回复评论 | 0.6 | 中等概率，鼓励深度互动 |
| 默认行为 | 0.3 | 兜底概率 |

#### 4.2.2 目标对象影响
- **对用户内容**: 概率提升至0.75
- **对机器人内容**: 保持基础概率0.6

### 4.3 时间因子计算

#### 4.3.1 时间段权重
| 时间段 | 权重 | 说明 |
|-------|------|------|
| 8:00-12:00 | 1.2 | 上午活跃期 |
| 14:00-18:00 | 1.3 | 下午活跃期 |
| 19:00-23:00 | 1.5 | 晚上最活跃期 |
| 0:00-6:00 | 0.3 | 深夜低活跃期 |
| 其他时间 | 0.8 | 一般活跃期 |

#### 4.3.2 实现逻辑
```java
private double getTimeMultiplier(Robot robot, LocalTime currentTime) {
    int hour = currentTime.getHour();
    if (hour >= 8 && hour <= 12) return 1.2;
    else if (hour >= 14 && hour <= 18) return 1.3;
    else if (hour >= 19 && hour <= 23) return 1.5;
    else if (hour >= 0 && hour <= 6) return 0.3;
    else return 0.8;
}
```

### 4.4 性格因子计算

#### 4.4.1 性格类型权重
| 性格类型 | 权重 | 说明 |
|---------|------|------|
| 文艺青年 | 0.6 | 相对内向 |
| 技术宅 | 0.7 | 中等社交倾向 |
| 时尚达人 | 0.9 | 高度社交 |
| 成熟稳重 | 0.4 | 谨慎社交 |
| 运动达人 | 0.8 | 积极社交 |
| 学霸女神 | 0.5 | 选择性社交 |
| 退休教师 | 0.3 | 保守社交 |
| 可爱萌妹 | 0.9 | 高度社交 |

#### 4.4.2 实现逻辑
```java
private double getSocialEnergyMultiplier(Robot robot) {
    String personality = robot.getPersonality();
    switch (personality) {
        case "文艺青年": return 0.6;
        case "技术宅": return 0.7;
        // ... 其他性格类型
        default: return 0.7;
    }
}
```

### 4.5 情绪因子计算

#### 4.5.1 情绪模型
- **基础情绪**: 0.7
- **情绪波动**: -0.3 到 +0.3
- **最终情绪**: 0.4 到 1.0

#### 4.5.2 实现逻辑
```java
private double getMoodMultiplier(Robot robot) {
    double baseMood = 0.7;
    double moodSwing = random.nextDouble() * 0.6 - 0.3;
    return baseMood + moodSwing;
}
```

### 4.6 随机因子计算

#### 4.6.1 随机范围
- **范围**: 0.3 到 0.7
- **目的**: 增加行为的不确定性
- **公式**: `0.3 + random.nextDouble() * 0.4`

### 4.7 概率边界控制

#### 4.7.1 边界限制
- **最小概率**: 0.05 (5%)
- **最大概率**: 0.95 (95%)
- **异常处理**: 返回默认概率0.3

#### 4.7.2 实现逻辑
```java
return Math.min(Math.max(finalProbability, 0.05), 0.95);
```

## 5. 行为控制机制

### 5.1 每日行为限制

#### 5.1.1 行为上限配置
| 行为类型 | 每日上限 | 说明 |
|---------|---------|------|
| 发布动态 | 10条 | 避免刷屏 |
| 评论 | 20条 | 鼓励互动但不过度 |
| 回复 | 15条 | 深度互动控制 |

#### 5.1.2 统计管理
```java
private static class RobotDailyStats {
    private int postCount = 0;
    private int commentCount = 0;
    private int replyCount = 0;
    private LocalDateTime lastReset = LocalDateTime.now();
}
```

### 5.2 活跃状态控制

#### 5.2.1 活跃时间检查
- 基于机器人配置的活跃时间段
- 调用 `robot.isInActiveTimeSlot()`
- 非活跃时间不执行行为

#### 5.2.2 状态刷新机制
```java
@Scheduled(fixedRate = 300000) // 5分钟间隔
public void refreshRobotActiveStatus()
```

### 5.3 内容过滤机制

#### 5.3.1 评论过滤
- 跳过机器人自己的帖子
- 检查是否已评论过
- 只对近3天的帖子进行评论

#### 5.3.2 回复过滤
- 跳过机器人自己的评论
- 检查是否已回复过
- 只对近3天的评论进行回复

## 6. 智能内容生成

### 6.1 上下文构建

#### 6.1.1 动态发布上下文
```java
private String buildPostContext() {
    return String.format(
        "现在是%s，%s。%s，%s。%s",
        now.format(DateTimeFormatter.ofPattern("yyyy年MM月dd日 HH:mm")),
        timeOfDay, weather, mood, activity
    );
}
```

#### 6.1.2 评论上下文
```java
private String buildCommentContext(String postContent) {
    return String.format("看到一条朋友圈动态：%s", postContent);
}
```

#### 6.1.3 回复上下文
```java
private String buildReplyContext(String commentContent) {
    return String.format("有人评论了：%s", commentContent);
}
```

### 6.2 随机元素生成

#### 6.2.1 天气描述
```java
private String getRandomWeather() {
    String[] weathers = {
        "阳光明媚，心情舒畅",
        "微风轻拂，很舒服",
        "阴天多云，适合思考",
        // ... 更多天气描述
    };
    return weathers[random.nextInt(weathers.length)];
}
```

#### 6.2.2 心情描述
```java
private String getRandomMood() {
    String[] moods = {
        "心情很愉快",
        "感觉还不错",
        "有点小开心",
        // ... 更多心情描述
    };
    return moods[random.nextInt(moods.length)];
}
```

#### 6.2.3 活动描述
根据时间段返回不同的活动描述，增加真实感。

## 7. 性能优化策略

### 7.1 缓存机制
- **本地缓存**: ConcurrentHashMap实现
- **统计缓存**: 机器人每日统计数据
- **状态缓存**: 机器人活跃状态

### 7.2 异步处理
- **AI任务异步**: 使用@Async注解
- **WebSocket推送**: 异步消息推送
- **批量处理**: 批量触发机器人行为

### 7.3 数据库优化
- **索引优化**: 时间、作者、状态字段索引
- **查询优化**: 分页查询，限制结果集
- **连接池**: 合理配置数据库连接

## 8. 监控与日志

### 8.1 日志级别
- **INFO**: 重要行为记录
- **DEBUG**: 详细执行过程
- **WARN**: 异常情况警告
- **ERROR**: 错误信息记录

### 8.2 关键指标
- 机器人行为触发成功率
- 每日行为统计
- 系统性能指标
- 异常情况统计

### 8.3 监控告警
- 机器人异常行为检测
- 系统性能监控
- 数据库连接监控

## 9. 配置管理

### 9.1 可配置参数
- 行为触发概率
- 每日行为上限
- 时间权重配置
- 性格权重配置

### 9.2 配置文件
- `robots-config.yaml`: 机器人基础配置
- `world-config.yaml`: 世界规则配置
- `application.yml`: 应用配置

## 10. 扩展性设计

### 10.1 新行为类型扩展
- 实现新的触发方法
- 添加对应的概率计算
- 更新统计管理

### 10.2 新因子扩展
- 添加新的影响因子
- 实现对应的计算方法
- 集成到概率计算公式

### 10.3 个性化扩展
- 支持机器人个性化配置
- 动态调整行为参数
- 学习用户偏好

## 11. 测试策略

### 11.1 单元测试
- 概率计算测试
- 行为触发测试
- 统计管理测试

### 11.2 集成测试
- 端到端行为测试
- 数据库交互测试
- WebSocket推送测试

### 11.3 性能测试
- 并发行为测试
- 内存使用测试
- 响应时间测试

## 12. 部署与运维

### 12.1 部署要求
- Java 8+
- Spring Boot 2.x
- MongoDB 4.x
- Redis (可选)

### 12.2 配置建议
- JVM内存配置
- 数据库连接池配置
- 定时任务线程池配置

### 12.3 运维监控
- 应用性能监控
- 数据库性能监控
- 系统资源监控

## 13. 总结

机器人触发算法通过多维度概率计算、智能行为控制和真实感模拟，成功实现了虚拟社交世界中机器人的自然行为。该算法具有良好的可扩展性、可配置性和可维护性，为"我的伊甸园"提供了丰富的社交体验。

### 13.1 核心优势
- **真实感强**: 多因子影响，模拟真实社交行为
- **可配置性高**: 支持个性化机器人配置
- **性能优良**: 异步处理，缓存优化
- **扩展性好**: 模块化设计，易于扩展

### 13.2 未来改进方向
- 引入机器学习算法
- 增加更复杂的情绪系统
- 支持机器人之间的互动
- 优化内容生成质量

---

**文档版本**: V1.0.0  
**最后更新**: 2024年12月  
**维护团队**: MyEden Team 